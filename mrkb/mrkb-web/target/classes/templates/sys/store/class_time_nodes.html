<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head><div th:replace="common/common :: common_resource"></div>
  <head>
    <title>课程时间节点</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
  	<style type="text/css">
  		.layui-timeline{
  			margin-top: 10px;
  		}
  		.tixingkaike{
  			position: relative;
  			left: 250px;
  			bottom: 40px;
  			width: 66px;
  		}
  	</style>
  </head>
  <body>
  <!--列表-->
	<div id="rapp">
	    <div v-show="showList">
	    	<!-- shiro按钮权限示例:<p shiro:hasPermission="sys:menu">有权限</p> -->
	    	<fieldset class="layui-elem-field site-demo-button" style="margin-top: 10px;">
			    <button class="layui-btn layui-btn-normal" @click="timeline"><i class="layui-icon layui-icon-search"></i>查看时间线</button>
			    <button class="layui-btn" @click="add"><i class="layui-icon layui-icon-add-1"></i>新增课程时间节点</button>
				<div class="layui-input-inline" style="width:200px;">
		           <input type="text" id="serch_menue_name" placeholder="课程名称" autocomplete="off" class="layui-input">
		        </div>
		        <div class="layui-input-inline" style="width:200px;">
		           <button class="layui-btn layui-btn-primary" @click="serch"><i class="layui-icon layui-icon-search"></i>搜索</button>
		        </div>
			</fieldset>
		    <table class="layui-table" lay-filter="test">
		        <thead>
		            <tr>
		                <th>ID</th>
		                <th>开课时间</th>
		                <th>截止报名时间</th>
		                <th>课程名称</th>
		                <th>开课地点</th>
		                <th>总人数</th>
		                <th>复训名额</th>
		                <th>复训费</th>
		                <th>课程次数（第几届）</th>
		                <th>导师姓名</th>
		                <th>操作</th>
		            </tr>
		        </thead>
		        <tbody>
		            <tr v-for="item in data">
		                <td>{{item.class_node_id}}</td>
		                <td>{{formatDateTimeStr(item.class_beagain_time,1)}}</td>
		                <td>{{formatDateTimeStr(item.enroll_end_time,1)}}</td>
		                <td>{{item.store_name}}</td>
		                <td>{{item.address}}</td>
		                <td>{{item.person_num}}</td>
		                <td>{{item.retraining_num}}</td>
		                <td>{{item.retraining_price}}</td>
		                <td>{{item.times}}</td>
		                <td>{{item.tutor_name}}</td>
		                <td>
							<a class="layui-btn layui-btn-xs" lay-event="edit" @click='edit(item.class_node_id)'><i class="layui-icon layui-icon-edit"></i>编辑</a>
							<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" @click='del(item.class_node_id)'><i class="layui-icon layui-icon-delete"></i>删除</a>
		                </td>
		            </tr>
		        </tbody>
		    </table>
	    	<!--分页容器-->
			<div id="pagination"></div>
    	</div>
    	<!-- 新增面板 -->
	    <div v-show="!showList" class="layui-card">
	    	<div class="layui-card-header">{{title}}</div>
	    	<div class="layui-card-body">
	    		<form class="layui-form" id="layui-form">
				    <div class="layui-form-item">
					    <label class="layui-form-label">课程开课时间</label>
				    	<div class="layui-input-block">
				        	<input type="text" id="class_beagain_time" name="class_beagain_time" required  lay-verify="required" v-model="Node.class_beagain_time" placeholder="请输入开课时间" autocomplete="off" class="layui-input">
				    	</div>
				    </div>
				    <div class="layui-form-item">
					    <label class="layui-form-label">截止报名时间</label>
				    	<div class="layui-input-block">
				        	<input type="text" name="enroll_end_time" id="enroll_end_time" required  lay-verify="required" v-model="Node.enroll_end_time" placeholder="请输入截止报名时间" autocomplete="off" class="layui-input">
				    	</div>
				    </div>
				    <div class="layui-form-item">
					    <label class="layui-form-label">课程名称</label>
				    	<div class="layui-input-block">
				        	<select name="store_id" id="store_id"  lay-verify="required" lay-filter="store_id">
				        		<option value=""></option>
				        	</select>
				    	</div>
				    </div>
				    <div class="layui-form-item">
			    	    <label class="layui-form-label">开课地点</label>
				        <div class="layui-input-block">
					       <input type="text" name="address" id="address" v-model="Node.address" placeholder="请输入开课地点" autocomplete="off" class="layui-input">
				        </div>
				     </div>
				     <div class="layui-form-item">
			    	    <label class="layui-form-label">开课人数</label>
				        <div class="layui-input-block">
					       <input type="text" name="person_num" id="person_num" v-model="Node.person_num" placeholder="请输入开课人数" autocomplete="off" class="layui-input">
				        </div>
				     </div>
				     <div class="layui-form-item">
			    	    <label class="layui-form-label">复训名额</label>
				        <div class="layui-input-block">
					       <input type="text" name="retraining_num" id="retraining_num" v-model="Node.retraining_num" placeholder="复训名额" autocomplete="off" class="layui-input">
				        </div>
				     </div>
				     <div class="layui-form-item">
			    	    <label class="layui-form-label">复训费</label>
				        <div class="layui-input-block">
					       <input type="text" name="retraining_price" id="retraining_price" v-model="Node.retraining_price" placeholder="复训费" autocomplete="off" class="layui-input">
				        </div>
				     </div>
				      <div class="layui-form-item">
					    <label class="layui-form-label">课程次数（届）</label>
				    	<div class="layui-input-block">
				        	<input type="text" name="times" id="times" v-model="Node.times" placeholder="第几届" autocomplete="off" class="layui-input">
				    	</div>
				      </div>
					  <div class="layui-form-item">
					     <div class="layui-input-block">
					       <button type="button" class="layui-btn" @click="save"><i class="layui-icon layui-icon-ok"></i>提交</button>
					       <button type="reset" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-refresh-3"></i>重置</button>
					       <button type="button" class="layui-btn layui-btn-primary" @click="reload"><i class="layui-icon layui-icon-return"></i>返回</button> 
					     </div>
					  </div>
				</form>
		    </div>
	    </div>
    </div>
<script type="text/javascript">
	var vm = new Vue({
		el: "#rapp",
	    data: {
	        data: null,
	        showList: true,
	        title: null,
	        Node: {},
	    },
	    //窗口加载事件
	    mounted: function(){this.getselectoptions()},
	    methods: {
	    	//新增
	    	add :function(){
	    		vm.getselectoptions();
	    		vm.Node = {};
	            vm.showList = false;
	            vm.title = "新增";
	    	},
	    	//搜索
	    	serch :function(){
	    		pagination(1,10,name);
	    	},
	    	//编辑
	    	edit :function(id){
	    		vm.Node = {};
	            vm.showList = false;
	            vm.title = "编辑";
	            vm.getselectoptions();
	            $.ajax({
	                type: "GET",
	                url: basePath+"/admin_time_nodes/getObject/"+id,
	                async:true,
	                success: function (r) {
	                	layui.use('form',function(){
	                		form=layui.form;
	                	});
	                	vm.Node = r.data;
	                	vm.Node.class_beagain_time=formatDateTimeStr(r.data.class_beagain_time,1);
	                	vm.Node.enroll_end_time=formatDateTimeStr(r.data.enroll_end_time,1);
	                	/* $('#store_id').val(r.data.store_id);  */
	                	layui.form.render();
	                	var select = 'dd[lay-value=' + r.data.store_id + ']';
	                	$('#store_id').siblings("div.layui-form-select").find('dl').find(select).click(); 
	                	layui.form.render('select');
	                },error:function(r){
	                	layer.msg(r.message);
	                }
	            });
	    	},
	    	//删除
	    	del :function(id){
	    		layer.confirm('是否删除？操作不可恢复！', {btn: ['确定','取消']}, function(){
				   $.get(basePath+"/admin_time_nodes/delete/"+id,function(data){
				   	   layer.msg(data.message);
				   	   vm.reload();
				   });
				}, function(){
				   layer.msg('取消操作', {icon: 2});
				});
	    	},
	    	//保存
	    	save :function(){
	    		var url = vm.Node.class_node_id == null ? "/admin_time_nodes/node_add" : "/admin_time_nodes/update";
	    		vm.Node.store_id=$("#store_id").val();;
	    		vm.Node.class_beagain_time=util_formatStrDateTime($("#class_beagain_time").val());
	    		vm.Node.enroll_end_time=util_formatStrDateTime($("#enroll_end_time").val());
	    		if(vm.Node.class_beagain_time == null || vm.Node.class_beagain_time.length<=0){
	        		layer.tips('开始时间不能为空', '#class_beagain_time', {
					  tips: [3, '#0FA6D8'] //还可配置颜色
					});
					return;
	        	};
	        	if(vm.Node.enroll_end_time == null || vm.Node.enroll_end_time.length<=0){
	        		layer.tips('截止报名时间不能为空', '#enroll_end_time', {
					  tips: [3, '#0FA6D8'] //还可配置颜色
					});
					return;
	        	};
	        	if(store_id == null || store_id.length<=0){
	        		layer.tips('课程名称不能为空', '#store_id', {
					  tips: [3, '#0FA6D8'] //还可配置颜色
					});
					return;
	        	};
	        	if(vm.Node.address == null || vm.Node.address.length<=0){
	        		layer.tips('开课地点不能为空', '#address', {
					  tips: [3, '#0FA6D8'] //还可配置颜色
					});
					return;
	        	};
	        	if(vm.Node.times == null || vm.Node.times.length<=0){
	        		layer.tips('开课次数不能为空', '#times', {
					  tips: [3, '#0FA6D8'] //还可配置颜色
					});
					return;
	        	};
	        	if(vm.Node.person_num == null || vm.Node.person_num.length<=0){
	        		layer.tips('开课人数不能为空', '#person_num', {
					  tips: [3, '#0FA6D8'] //还可配置颜色
					});
					return;
	        	};
	        	$.ajax({
	                type: "POST",
	                url: basePath+url,
	                contentType:'application/json',
	                async:true,
	                data: JSON.stringify(vm.Node),
	                success: function (r) {
	                    vm.reload();
                        layer.msg(r.message);
	                },error:function(r){
	                	layer.msg(r.message);
	                }
	            });
	    	},
	    	//刷新
	    	reload :function(){
	    		vm.serch();
	    		vm.showList = true;
	    	},
	    	//查询菜单下拉框列表
	        getselectoptions :function(){
	        	$.get(basePath+"/store/findStore",function (r) {
	        		var html="<option value=''>请选择</option>";
		        	for(var i=0;i<r.data.length;i++){
		        		html+="<option value='"+r.data[i].store_id+"'>"+r.data[i].store_name+"</option>";
		        	}
		        	$("#store_id").html(html);
           		});
	        },
	        timeline :function(){
	        	var timestamp =(new Date()).valueOf();
	        	$.get(basePath+"/admin_time_nodes/gettimeline", function(data){
	        		var html="";
	        		html+="<ul class='layui-timeline'>";
	        		for(var i=0;i<data.data.length;i++){
						  html+="<li class='layui-timeline-item'>";
					      if(i==0){
					      	html+="<i style='font-size:28px;' class='layui-icon layui-timeline-axis'>&#xe60e;</i>";
					      }else{
					      	html+="<i class='layui-icon layui-timeline-axis'>&#xe60e;</i>";
					      }
					      html+="<div class='layui-timeline-content layui-text'>";
					      html+="<h3 class='layui-timeline-title'>"+formatDateTimeStr(data.data[i].class_beagain_time)+"</h3>";
					      html+="<p>";
				          html+=" "+data.data[i].store_name+" ";
				          html+="("+data.data[i].address+")第"+data.data[i].times+"届";
				          html+="<br>&nbsp;&nbsp;截止报名时间："+formatDateTimeStr(data.data[i].enroll_end_time)+"</i>";
					      html+="</p>";
					      if(data.data[i].class_beagain_time < timestamp){
					      	html+="<div class='tixingkaike'><button class='layui-btn layui-btn-sm layui-btn-disabled'>已超时</button></div>";
						  }else{
						  	html+="<div class='tixingkaike'><button type='button' onclick=\"sendNoitice('"+data.data[i].class_node_id+"');\" class='layui-btn layui-btn-sm'>开课提醒</button></div>";
						  }
					      html+="</div>";
						  html+="</li>";
	        		}
	        		html+="</ul>";
					layer.open({
					  type: 1,
					  title:'课程时间线',
					  area: ['400px', '500px'],
					  fixed: false, //不固定
					  maxmin: true,
					  content: html
					});
	        	})
	        },
	    }
	});
	//使用layui分页
    var pageIndex = 1;
	var pageSize = 10;
	var totalCount = 0;
	pagination(pageIndex,pageSize);
	layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element','form','slider'], function(){
	    var laydate = layui.laydate,
	    layer = layui.layer, //弹层
	    table = layui.table, //表格
	    carousel = layui.carousel, //轮播
	    upload = layui.upload, //上传
	    element = layui.element, //元素操作
	    slider = layui.slider, //滑块
	    form = layui.form,
	    laypage = layui.laypage
	    laypage.render({
	        elem: 'pagination'
	        , count: totalCount
	        , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
	        , jump: function (obj, first) {
	            //点击非第一页页码时的处理逻辑。比如这里调用了ajax方法，异步获取分页数据
	            if (!first) {
	                pagination(obj.curr, obj.limit);//第二个参数不能用变量pageSize，因为当切换每页大小的时候会出问题
	            }
	        },
	        
	    });
        //日期时间选择器
        laydate.render({elem: '#class_beagain_time',type: 'datetime',theme: '#393D49'});
        laydate.render({elem: '#enroll_end_time',type: 'datetime',theme: '#393D49'});
	});
	function pagination(pageIndex,pageSize,name){
		//查询条件
	    var param = {
	        pageIndex: pageIndex,
	        pageSize: pageSize,
	        name: name
	        //其它查询条件可在下面添加
	    };
	    $.ajax({
	        type: 'POST',
	        url: basePath+'/admin_time_nodes/getlist',
	        dataType: 'json',
            data: param,
	        async: false,//这里设置为同步执行，目的是等数据加载完再调用layui分页组件，不然分页组件拿不到totalCount的值
	        success: function (data) {
	            vm.data = data.data.list;
	            totalCount = data.data.total;
	        }
	    });
	};
	
	
	//发送消息通知
	function sendNoitice(id){
		$.post(basePath+'/admin_time_nodes/send_notice/'+id,function(data) {
			layer.msg("通知成功");
		});
	}
</script>
  </body>
</html>

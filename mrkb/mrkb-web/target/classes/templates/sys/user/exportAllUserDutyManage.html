<html xmlns:th="http://www.thymeleaf.org">
<head>
<div th:replace="common/common :: common_resource"></div>
<meta charset="utf-8">
<title>所有员工当班数据导出</title>
<style type="text/css">
.uploader-list {
	margin-left: -15px;
}

.uploader-list .info {
	position: relative;
	margin-top: -25px;
	background-color: black;
	color: white;
	filter: alpha(Opacity = 80);
	-moz-opacity: 0.5;
	opacity: 0.5;
	width: 100px;
	height: 25px;
	text-align: center;
	display: none;
}

.uploader-list .handle {
	position: relative;
	background-color: black;
	color: white;
	filter: alpha(Opacity = 80);
	-moz-opacity: 0.5;
	opacity: 0.5;
	width: 100px;
	text-align: right;
	height: 18px;
	margin-bottom: -18px;
	display: none;
}

.uploader-list .handle span {
	margin-right: 5px;
}

.uploader-list .handle span:hover {
	cursor: pointer;
}

.uploader-list .file-iteme {
	margin: 12px 0 0 15px;
	padding: 1px;
	float: left;
}
</style>
</head>
<body>
	<!--列表-->
	<div id="vueContainer">
		<div v-show="showList">
			<fieldset class="layui-elem-field site-demo-button"
				style="margin-top: 30px;">
				<div class="layui-inline">
				      <label class="layui-form-label">开始时间:</label>
				      <div class="layui-input-inline">
				        <input type="text" class="layui-input" id="test3" placeholder="">
				      </div>
				</div>
				<div class="layui-inline">
					      <label class="layui-form-label">结束时间:</label>
					      <div class="layui-input-inline">
					        <input type="text" class="layui-input" id="test4" placeholder="">
					      </div>
				</div>
				<div class="layui-input-inline" style="width:200px;">
					<button class="layui-btn layui-btn-primary" id="search_btn">
						<i class="layui-icon layui-icon-search"></i>搜索
					</button>
				</div>
				<div class="layui-input-inline" style="width:200px; ">
					<form class="layui-form">
						<label class="layui-form-label">类型</label>
						<div class="layui-input-block" style="width:190px;">
							<select name="if_duty" lay-filter="if_duty"
								id="if_duty">
								<option value="-1">全部</option>
								<option value="1">当班</option>
								<option value="0">未当班</option>
							</select>
						</div>
					</form>
				</div>
				<div class="layui-input-inline"  style="width:200px;margin-left:70px ">
					<form class="layui-form">
						<label class="layui-form-label">来源</label>
						<div class="layui-input-block" style="width:190px;">
							<select name="source_type" lay-filter="source_type"
								id="source_type">
								<option value="0">全部</option>
								<option value="1">购买课程</option>
							    <!--<option value="2">赠送课程</option>-->
								<option value="3">复训课程</option>
							</select>
						</div>
					</form>
				</div>
				<!-- <div><button class="layui-btn" id="export">
		            <i class="iconfont icon-export"></i> 导出
		        </button>
		        </div> -->
			</fieldset>
			<table class="layui-hide" lay-filter="test" id="data_export">
			</table>
			<!--分页容器-->
			<div id="pagination"></div>
		</div>
	</div>
	<script type="text/javascript" th:inline="none">
	    var ifDutys =-1;//当班类型默认为全部
	    var sourceTypes =0;//来源类型默认为全部
	    //初始化日期
	    var date = new Date();
		var nowYear = date.getFullYear();
		var month = ("0" + (date.getMonth() + 1)).slice(-2); 
		var beginTime = nowYear+'-'+month;
	    var endTime =nowYear+'-'+month;
	    $("#test3").val(nowYear+"-"+month);//初始化开始日期
	    $("#test4").val(nowYear+"-"+month);//初始化结束日期
		layui.use('laydate', function(){
  		var laydate = layui.laydate;
		  //常规用法
		  laydate.render({
		    elem: '#test1'
		  });
		  
		  //国际版
		  laydate.render({
		    elem: '#test1-1'
		    ,lang: 'en'
		  });
		  
		  //年选择器
		  laydate.render({
		    elem: '#test2'
		    ,type: 'year'
		  });
		  
		 //年月选择器 开始时间
		  laydate.render({
		    elem: '#test3'
		    ,type: 'month'
		  });
		   //年月选择器 结束时间
		  laydate.render({
		    elem: '#test4'
		    ,type: 'month'
		  });
	  });
		//数据渲染
		layui.use([ 'table', 'layer', 'form', 'layer' ], function() {
			var table = layui.table; //表格
			var form = layui.form; //表单
			var layer = layui.layer; //弹层
			var $ = layui.jquery;
			var exportData = " "; //定义全局导出数据变量
			table.render({ //数据渲染
				elem : '#data_export',
				url : basePath + '/admin_userInfo/excelFindAllDutyList',
				limit : 10,
				toolbar : true,
				loading : true,
				page : false,
				title : '公司报表数据管理',
				where : {
				  source_type : sourceTypes,
				  if_duty : ifDutys,
				  begin_time :beginTime,
				  end_time : endTime
				},
				cols : [ [
					/*{
						type : 'checkbox'
					},*/
					{
						type : 'numbers',
						title : '序号',
						align : 'center',
						width : 60
					},
					{
						field : 'user_basics_id',
						title : '用户编号',
						sort : true,
						width : 120
					},
					{
						field : 'information_compellation',
						title : '姓名'
					},
					{
						field : 'information_phone',
						title : '电话',
						width : 120
					},
					{
						field : 'information_sex',
						title : '性别'
					},
					{
						field : 'store_name',
						title : '课程名称'
					},
					{
						field : 'recommend_name',
						title : '推荐人'
					},
					{
						field : 'employees',
						title : '所属员工'
					},
					{
						field : 'user_resources',
						title : '客户资源'
					},
					{
						field : 'order_id',
						title : '订单编号'
					},
					{
						field : 'order_date',
						title : '缴费时间',
						width : 210
					},
					{
						field : 'all_price',
						title : '订单价格'
					},
					{
						field : 'if_duty',
						title : '是否当班'
					},
					{
						field : 'source_type',
						title : '课程来源'
					},
					{
						field : 'duty_date',
						title : '当班时间',
						width : 210
					},
					/* {
						field : 'add_date',
						title : '添加时间',
						width : 210
					}, */
					
				] ],
				 request : { //修改默认参数limit及page名称
					pageName : 'pageIndex',
					limitName : 'pageSize'
				},
				parseData : function(res) {
				//console.log(res.data);
					var data = res.data;
					for (index in data) { //解决导出时间格式问题  下单日期
						var date = data[index].order_date
						var time = new Date(date);
                        if(date ==0 || date ==null){
                            data[index].order_date = null;
                        }else{
                            data[index].order_date = formatDateTimeStr(data[index].order_date,1);
                        }
						//data[index].add_date = time.getFullYear() + "-" + (time.getMonth() + 1) + "-" + time.getDate() + " " + time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();
					}
				/* 	for (index1 in data) { //解决导出时间格式问题  下单日期
						var add_date = data[index1].add_date;
						var time = new Date(add_date);
						data[index1].add_date = formatDateTimeStr(data[index1].add_date,1);
						//data[index].add_date = time.getFullYear() + "-" + (time.getMonth() + 1) + "-" + time.getDate() + " " + time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();
					} */
					for (dutyDate in data) { //解决导出时间格式问题  当班日期
						var date = data[dutyDate].duty_date;
                        var time = new Date(date);
						if(date ==0 || date ==null){
                            data[dutyDate].duty_date = null;
						}else{
                            data[dutyDate].duty_date = formatDateTimeStr(data[dutyDate].duty_date,1);
						}
						//data[index].add_date = time.getFullYear() + "-" + (time.getMonth() + 1) + "-" + time.getDate() + " " + time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds();
					}
	
					 for (informationSex in data) { //商品课程类型
						var information_sex = data[informationSex].information_sex;
						if (information_sex == 1) {
							data[informationSex].information_sex = "男";
						} else if (information_sex == 0) {
							data[informationSex].information_sex = "女";
						} else{
							data[informationSex].information_sex = "";
						}
					}
					for (userResources in data) { //学院类型
						var user_resources = data[userResources].user_resources;
						if (user_resources == 1) {
							data[userResources].user_resources = "公司资源";
						} else if (user_resources == 2) {
							data[userResources].user_resources = "个人资源";
						}else {
							data[userResources].user_resources == "";
						}
					}
					for (ifDuty in data) { //会员等级类型
						var if_duty = data[ifDuty].if_duty;
						if (if_duty == 0) {
							data[ifDuty].if_duty = "否";
						} else if (if_duty == 1) {
							data[ifDuty].if_duty = "是";
						}else {
							data[ifDuty].if_duty == "";
						}
					}
					for (sourceType in data) { //课程来源
						var source_type = data[sourceType].source_type;
						if (source_type == 1) {
							data[sourceType].source_type = "购买课程";
						} else if (source_type == 3) {
							data[sourceType].source_type = "复训课程";
						}else {
							data[sourceType].source_type == "";
						}
					}
					return { //返回数据
						"code" : res.errorCode == 200 ? 0 : -1,
						"msg" : res.message,
						//"count" : res.data.total,
						data : res.data
					}
	
				},
				done : function(res, curr, count) {
					// console.log(res.data);
					//layer.alert("暂无数据");
					//exportData = res.data; //获取表格中的数据集合。
					if (res.data == null)
                		{
                    		$(".layui-table-main").html('<div class="layui-none">暂无数据</div>');
                		}
				}
			});
			//关键字搜索数据 
			var $ = layui.$,
			    layer = layui.layer,
				active = {
					getCheckData : function() { //获取选中数据
						var checkStatus = table.checkStatus('idTest'),
							data = checkStatus.data;
						layer.alert(JSON.stringify(data));
					},
					getCheckLength : function() { //获取选中数目
						var checkStatus = table.checkStatus('idTest'),
							data = checkStatus.data;
						layer.msg('选中了：' + data.length + ' 个');
					},
					isAll : function() { //验证是否全选
						var checkStatus = table.checkStatus('idTest');
						layer.msg(checkStatus.isAll ? '全选' : '未全选')
					},
					reload : function() {
					    if($("#test3").val() ==null || $("#test3").val() =="" || $("#test3").val() ==""){
						     layer.alert("请选择开始日期");
						     return;
					    }else{
					       beginTime = $("#test3").val();
					    }
						if($("#test4").val() ==null || $("#test4").val() =="" || $("#test4").val() ==""){
							 layer.alert("请选择结束日期");
							 return;
					    }else{
					      endTime= $("#test4").val();
					    }
						
						//alert(begin_time);
						if (1) {
							//console.log(1);
							table.reload('data_export',
								{
									/* page : {
										curr : 1 //重新从第 1 页开始
									}, */
									where : {
										source_type : sourceTypes,
										if_duty : ifDutys,
										begin_time :beginTime,
										end_time : endTime
										//if_duty : ifDuty,
										//source_type : sourceType
									}, //这里传参  向后台
									url : basePath + '/admin_userInfo/excelFindAllDutyList', //后台做模糊搜索接口路径
									method : 'get',
									page : false
								});
						}
					},
					selectReloadByIfDuty : function() {
						//var name =$("#shelf_state option:selected").val();
						if (1) {
							//console.log(ifDuty);
						   //alert(sourceTypes+","+ifDutys);
							table.reload('data_export',
								{
									/* page : {
										curr : 1 //重新从第 1 页开始
									}, */
									where : {
										source_type : sourceTypes,
										if_duty : ifDutys,
										begin_time :beginTime,
										end_time : endTime
									}, //这里传参  向后台
									url : basePath + '/admin_userInfo/excelFindAllDutyList', //后台做模糊搜索接口路径
									method : 'get',
									page : false
								});
						}
					},
					selectReloadBySourceType : function() {
						//var name =$("#shelf_state option:selected").val();
						if (1) {
							//alert(sourceTypes+","+ifDutys);
							table.reload('data_export',
								{
									/* page : {
										curr : 1 //重新从第 1 页开始
									}, */
									where : {
										source_type : sourceTypes,
										if_duty : ifDutys,
										begin_time :beginTime,
										end_time : endTime
									}, //这里传参  向后台
									url : basePath + '/admin_userInfo/excelFindAllDutyList', //后台做模糊搜索接口路径
									method : 'get',
									page : false
								});
						}
					}
				};
	
			$('#search_btn').on('click', function() { //触发搜索事件，根据商品名称查询
				var type = 'reload';
				active[type] ? active[type].call(this) : ''; 
			});
			
			form.on('select(if_duty)', function(data) { //根据下拉框状态值（if_duty 是否当班（1当班，2未当班）） 展示不同状态数据
				ifDutys = data.value;
				var type = 'selectReloadByIfDuty';
				active[type] ? active[type].call(this) : '';
	
			});
			form.on('select(source_type)', function(data) { //根据下拉框状态值（source_type 来源（1购买课程，3复训课程）） 展示不同状态数据
				sourceTypes = data.value;
				var type = 'selectReloadBySourceType';
				active[type] ? active[type].call(this) : '';
	
			});
			/* form.on('select(shelf_state)', function(data) { //根据下拉框状态值（shelf_state 是否下架（1上架，2下架）） 展示不同状态数据
				isShelfState = data.value;
				var type = 'selectReload';
				active[type] ? active[type].call(this) : '';
	
			});
			table.on('tool(test)', function(obj){//根据table监听编辑，删除操作
			    var data = obj.data;
			    if(obj.event === 'detail'){
			      layer.msg('ID：'+ data.store_id + ' 的查看操作');
			    } else if(obj.event === 'del'){
			         vue.del(data.store_id);////跳转至vue的删除方法
			    } else if(obj.event === 'edit'){
			       vue.edit(data.store_id);//跳转至vue的编辑方法
			     // layer.alert('编辑行：<br>'+ JSON.stringify(data))
			    }else if(obj.event === 'isShelfState'){
			    //alert(data.shelf_state);
			    var state ="";
			    if(data.shelf_state=="上架"){
			       state =1;
			       vue.isShelfState(data.store_id,state);
			    }else if(data.shelf_state=="下架"){
			    	state =2;
			    	vue.isShelfState(data.store_id,state);
			    }
			   }
			  }); */
			
			
		/*  $("#export").click(function(){
		// alert(JSON.stringify(exportData));
		       	table.exportFile(ins1.config.id,exportData, 'xls');
		 }); */
		});
		// 初始化日期
	 function getInitMonth(flag){
		var date = new Date();
		var nowYear = date.getFullYear();
		var month = ("0" + (date.getMonth() + 1)).slice(-2); 
		var day = ("0" + date.getDate()).slice(-2);
		var today = nowYear+"-"+(month); 
		if(flag){
			//设置为当年第一天
			return nowYear+"-01-01";
		}else{
			//设置为当天
			return today;
		}
	}
	</script>
</body>
</html>

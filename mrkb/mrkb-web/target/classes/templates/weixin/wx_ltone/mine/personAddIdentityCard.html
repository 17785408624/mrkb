<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<title>新增身份证信息</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/weui.min.css" th:href="@{/css/wx_ltone/weui.min.css}"/>
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/jquery-weui.css" th:href="@{/css/wx_ltone/jquery-weui.css}"/>
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/reset.css" th:href="@{/css/wx_ltone/reset.css}"/>
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/mainstyle.css" th:href="@{/css/wx_ltone/mainstyle.css}" />
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/public.css" th:href="@{/css/wx_ltone/public.css}" />
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/mine.css" th:href="@{/css/wx_ltone/mine.css}"/>
		<link rel="stylesheet" type="text/css" href="../../css/wx_ltone/personAddIdentityCard.css" th:href="@{/css/wx_ltone/personAddIdentityCard.css}"/>
	
	</head>
	<body>
		<div class="search">
			<div class="search-left">
				<a  href="javascript:history.go(-1);">
					<img th:src="@{/img/wx_ltone/icon/mine/fanhui.png}">
				</a>
			</div>
		</div>
		<div class="mdfd-content">
			<ul class="mui-table-view">
				<li class="custom-table-view-cell">
					<div class="mui-input-row">
						<label><span>*</span>姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名： </label>
						<input id="real_name" type="text" placeholder="真实姓名">
					</div>
				</li>
				<li class="custom-table-view-cell">
					<div class="mui-input-row">
						<label><span>*</span>性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别：</label>
						<select id="sex" name="sex">
							<option>选择性别</option>
							<option value="1">男</option>
							<option value="0">女</option>
						</select>
					</div>
				</li>
				<li class="custom-table-view-cell">
					<div class="mui-input-row">
						<label><span>*</span>手&nbsp;机&nbsp;号&nbsp;码：</label>
						<input id="tel_num" type="number" placeholder="手机号码">
					</div>
				</li>
				<li class="custom-table-view-cell">
					<div class="mui-input-row">
						<label><span>*</span>身份证号码：</label>
						<input id="ID_card_num" type="text" placeholder="身份证号码">
					</div>
				</li>
				<li class="custom-table-view-cell">
					<div class="mui-input-row">
						<label><span>*</span>身份证正面：</label>
						<div class="iden-box">
							<div class="iden" id="frontIDCard">
								<input type="file"  name="file" accept="image/*" multiple="multiple" id="frontPicture" onchange="uploadIdentityCard(this)">
								<i>点击上传身份证正面</i>
							</div>
						</div>
					</div>
				</li>
				<li class="custom-table-view-cell">
					<div class="mui-input-row">
						<label><span>*</span>身份证反面：</label>
						<div class="iden-box">
							<div class="iden" id="reverseIDCard">
								<input type="file"  name="file" accept="image/*" multiple="multiple" id="reversePicture" onchange="uploadIdentityCard(this)">
								<i>点击上传身份证反面</i>
							</div>
						</div>
					</div>
				</li>
			</ul>
			<div style="clear: both;"></div>
			<div class="submit-add-idinfo-box">
				<input type="button" class="weui-btn weui-btn_primary btn" onclick="submitIDCardInfo()" value="保存">
			</div>
		</div>
		<script src="../../static/js/wx_ltone/jquery-2.1.4.js" th:src="@{/js/wx_ltone/jquery-2.1.4.js}" ></script>
		<script src="../../static/js/wx_ltone/fastclick.js" th:src="@{/js/wx_ltone/fastclick.js}" ></script>
		<script src="../../static/js/wx_ltone/jquery-weui.js" th:src="@{/js/wx_ltone/jquery-weui.js}" ></script>
		<script src="../../static/js/wx_ltone/ajaxfileupload.js" th:src="@{/js/wx_ltone/ajaxfileupload.js}" ></script>
		<script src="../../static/js/basePathConfig.js" th:src="@{/js/basePathConfig.js}" ></script>
		<script>
			$(function() {
				FastClick.attach(document.body);
				
				
				// 增改身份证信息
				$.ajax({ 
			    	type : "GET", //提交方式 
			     	url : basePath + '/user_weixin/findUserInformOne',
			     	contentType:"application/json",
			     	data : {
			     		
			     	} ,//数据，这里使用的是Json格式进行传输 
			     	success : function(result) {
			     		//返回数据根据结果进行相应的处理 
			      		// alert(JSON.stringify(result));
		      			if(result.data != null || result.data != ''){
		      				showinfomart(result.data);
		      			}
			     	},
			     	error: function (err){
			     		$.toast('网络错误，请稍后重试...');
			     		return;
			     	}
			    });
			});
			
			 /*展示个人身份详情信息*/
			function showinfomart(data) {
				if( data.information_compellation != null ){
					$('#real_name').val(data.information_compellation);
					var sex = "";
					if (data.information_sex == 1) {
						sex = "男";
					} else if (data.information_sex == 0) {
						sex = "女";
					} else {
						sex = "未知";
					}
					$('#sex').html('<option>' + sex + '</option><option value="1">男</option><option value="0">女</option>');
					$('#tel_num').val(data.information_phone);
					$('#ID_card_num').val(data.information_card);
					var image = new Array();
					/*首次加载显示身份证图片信息并作相关处理start*/
					$('#frontIDCard').html('');
					var frontImg = $("<img />"); //创建img标签
				    frontImg.attr('src',baseImgPath + data.identityCard_img1); // 设置标签属性src
					frontImg.attr('id','frontIDCardPicture'); // 设置标签属性id
					$("#frontIDCard").html('<input type="file"  name="file" accept="image/*" multiple="multiple" id="frontPicture" onchange="uploadIdentityCard(this)">');// 清空frontIDCard标签填充内容
				    $("#frontIDCard").append(frontImg); //将新创建的img标签插到id为frontIDCard的标签中
					
					var reverseImg = $("<img />"); //创建img标签
				    reverseImg.attr('src',baseImgPath + data.identityCard_img2); //设置标签属性
					reverseImg.attr('id','reverseIDCardPicture'); // 设置标签属性id
					$("#reverseIDCard").html('<input type="file"  name="file" accept="image/*" multiple="multiple" id="reversePicture" onchange="uploadIdentityCard(this)">');// 清空frontIDCard标签填充内容
				    $("#reverseIDCard").append(reverseImg); //将新创建的img标签插到id为frontIDCard的标签中
				}
				
			}
			
			var frontIDCardPictureSrc = '',reverseIDCardPictureSrc = '';
			// 上传身份证正反面
			function uploadIdentityCard(obj){
           		if(obj.id =="frontPicture"){
               		ajax_upload(obj.id, function(data) { //function(data)是上传图片的成功后的回调方法
		            	frontIDCardPictureSrc = data.data.src; //获取的图片的绝对路径
		            	var imgEl = $("<img />"); //创建img标签
					    imgEl.attr('src',baseImgPath + frontIDCardPictureSrc); // 设置标签属性src
						imgEl.attr('id','frontIDCardPicture'); // 设置标签属性id
						$("#frontIDCard").html('<input type="file"  name="file" accept="image/*" multiple="multiple" id="frontPicture" onchange="uploadIdentityCard(this)">');// 清空frontIDCard标签填充内容
					    $("#frontIDCard").append(imgEl); //将新创建的img标签插到id为frontIDCard的标签中
		        	});
               	}else if(obj.id =="reversePicture"){
                	ajax_upload(obj.id, function(data) { //function(data)是上传图片的成功后的回调方法
		            	reverseIDCardPictureSrc = data.data.src; //获取的图片的绝对路径
		            	var imgEl = $("<img />"); //创建img标签
					    imgEl.attr('src',baseImgPath + reverseIDCardPictureSrc); //设置标签属性
						imgEl.attr('id','reverseIDCardPicture'); // 设置标签属性id
						$("#reverseIDCard").html('<input type="file"  name="file" accept="image/*" multiple="multiple" id="reversePicture" onchange="uploadIdentityCard(this)">');// 清空frontIDCard标签填充内容
					    $("#reverseIDCard").append(imgEl); //将新创建的img标签插到id为frontIDCard的标签中
			        });
              	}
            }
            
            
            /*上传图片方法及回调方法，使用插件ajaxfileupload.js*/   
    		function ajax_upload(picture_upload, callback) { //具体的上传图片方法
				if(image_check(picture_upload)){ //自己添加的文件后缀名的验证
					$.ajaxFileUpload({
				    	data:{},
				   		fileElementId: picture_upload,    //需要上传的文件域的ID，即<input type="file">的ID。
				   		url: basePath + '/file_weixin/uploadIDCard', //后台方法的路径
				   		type: 'post',   //当要提交自定义参数时，这个参数要设置成post
						dataType: 'json',   //服务器返回的数据类型。可以为xml,script,json,html。如果不填写，jQuery会自动判断。
						secureuri: false,   //是否启用安全提交，默认为false。
				      	async : true,   //是否是异步
				      	success: function(data) {
				        	//提交成功后自动执行的处理函数，参数data就是服务器返回的数据。
				        	if(callback) callback.call(this, data);
				     			$.alert("上传成功");  
				        },
			        	error: function(data, status, e) {  //提交失败自动执行的处理函数。
			           		$.toast('网络错误，请稍后重试...');
			           		return;
			         	}
				     });
				}
	          }
            /*检查上传文件是否为图片*/
	  		function image_check(picture_upload) { //自己添加的文件后缀名的验证
	        	var img = document.getElementById(picture_upload);
	        	return /.(jpg|png|gif|bmp|mp4)$/.test(img.value)?true:(function() {
	            	$.alert('图片格式仅支持jpg、png、gif、bmp格式，且区分大小写。');
	            	return false;
	        	})();
		    }
			
			// 提交身份信息
			function submitIDCardInfo() {
				var realName = $('#real_name').val(); // 真实姓名
				if (!realName) {
					$.alert("您的姓名为空，请填写...");
					return;
				}
				
				var sex = getSex(); // 性别
				if (sex == '选择性别') {
					$.alert("您的性别为空，请选择...");
					return;
				}

				var telNum = $('#tel_num').val(); //手机号码
				if (!telNum) {
					$.alert("您的手机号码为空，请填写...");
					return;
				}

				if (!is_TelPhoneNumber(telNum)) {
					$.alert("您的手机号码格式不正确，请填写...");
					return;
				}
				var IDCardNum = $('#ID_card_num').val(); //身份证号码
				if (!IDCardNum) {
					$.alert("您的身份证号码为空，请填写...");
					return;
				}
				if (!is_IDCard(IDCardNum)) {
					$.alert("您输入的身份证号码不合法！请重新输入...");
					return;
				}
				
				var frontIDCardPicture  = $('#frontIDCardPicture').attr('src');
				if(frontIDCardPicture == ''){
					$.alert("请上传身份证正面照");
				 	return;
				}
				var reverseIDCardPicture  = $('#reverseIDCardPicture').attr('src');
				if(reverseIDCardPicture==''){
				 	$.alert("请上传身份证反面照");
				 	return;
				}
				
				// 增改身份证信息
				$.ajax({ 
			    	type : "GET", //提交方式 
			     	url : basePath + '/user_weixin/updateUserInformation',
			     	contentType:"application/json",
			     	data : {
			     		information_compellation: realName,  // 真实姓名
						information_phone: telNum,			// 电话号码
						information_card: IDCardNum,		// 身份证号码
						information_sex: sex,				// 性别
						identityCard_img1: frontIDCardPicture.split('file')[1],
						identityCard_img2: reverseIDCardPicture.split('file')[1]
			     	} ,//数据，这里使用的是Json格式进行传输 
			     	success : function(result) {
			     		//返回数据根据结果进行相应的处理 
			      		//alert(JSON.stringify(result));
		      			window.location = basePath + '/maid/personIdentityCard'
			     	},
			     	error: function (err){
			     		$.toast('网络错误，请稍后重试...');
			     		return;
			     	}
			    });
				
			}
			
			// 获取选择性别
			function getSex() {
				var objSex = document.getElementById("sex");
				var selectedSex = objSex.options[objSex.selectedIndex].value;
				return selectedSex;
			}
			
			/**
			 * 判断是否是身份证
			 * @param {Object} cardnum  需要验证的身份证号码
			 */
			function is_IDCard(cardnum) {
				// 身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X 
				var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
				if (reg.test(cardnum) === false) {
					return false;
				} else {
					return true;
				}
			}

			/**
			 * 手机号正则表达式
			 */
			function is_TelPhoneNumber(telNum) {
				if (!(/^1[1-9][0-9]\d{4,8}$/.test(telNum))) {
					return false;
				} else {
					return true;
				}
			}
			
		</script>
	</body>
</html>

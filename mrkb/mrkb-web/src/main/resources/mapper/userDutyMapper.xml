<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mrkb.dao.dao.UserDutyMapper">


	<select id="findUserDuty" parameterType="com.mrkb.dao.modle.store.UserDuty"
		resultType="com.mrkb.dao.modle.store.UserDuty">
		select a.*,c.store_id,c.store_name,d.information_compellation from user_duty a
		left join
		order_basics b on a.order_id=b.order_id
		left join store_basics c on
		c.store_id=b.store_id
		left join  user_information d on a.user_basics_id=d.user_basics_id
		where 1=1
		<if test="user_basics_id!=null">
			and a.user_basics_id= #{user_basics_id,jdbcType=INTEGER}
		</if>
		<if test="if_duty!=null">
			and a.if_duty= #{if_duty,jdbcType=INTEGER}
		</if>
		<if test="duty_id!=null">
			and a.duty_id= #{duty_id,jdbcType=INTEGER}
		</if>
		order by a.add_date desc
	</select>
	<update id="duty" parameterType="com.mrkb.dao.modle.store.UserDuty">
		UPDATE user_duty SET
		if_duty=1,duty_date=#{duty_date,jdbcType=BIGINT}
		WHERE 1=1
		and if_duty=0
		and user_basics_id= #{user_basics_id,jdbcType=INTEGER}
		and duty_id=
		#{duty_id,jdbcType=INTEGER}
	</update>
	<select id="isduty" parameterType="int" resultType="int">
		select
		count(*) from (
		select count(*) from user_duty a
		left join order_basics
		b on a.order_id=b.order_id
		LEFT JOIN store_basics c on
		c.store_id=b.store_id
		where 1=1
		and
		a.user_basics_id=#{user_basics_id,jdbcType=INTEGER}
		and a.if_duty=1
		and
		c.is_letang=1
		GROUP BY b.store_id ) d
	</select>
	<insert id="addUserDuty" parameterType="com.mrkb.dao.modle.store.UserDuty"
		useGeneratedKeys="true" keyProperty="duty_id">
		insert into user_duty
		(
		user_basics_id
		,order_id
		,if_duty
		,add_date
		,duty_date
		,source_type
		,store_id
		)
		value (
		#{user_basics_id,jdbcType=INTEGER}
		,#{order_id,jdbcType=INTEGER}
		,#{if_duty,jdbcType=INTEGER}
		,#{add_date,jdbcType=INTEGER}
		,#{duty_date,jdbcType=INTEGER}
		,#{source_type,jdbcType=INTEGER}
		,#{store_id,jdbcType=INTEGER}
		)
	</insert>
	<select id="countDuty" parameterType="int" resultType="int">
		select
		count(*) from user_duty a
		where 1=1
		and
		a.user_basics_id=#{user_basics_id,jdbcType=INTEGER}
		and a.if_duty=1
	</select>
	<select id="noduty" parameterType="int" resultType="com.mrkb.dao.modle.store.UserDuty">
		select
		* from user_duty a
		where 1=1
		and
		a.user_basics_id=#{user_basics_id,jdbcType=INTEGER}
		and a.if_duty=0
	</select>
	<select id="findOne" parameterType="int" resultType="com.mrkb.dao.modle.store.UserDuty">
		select
		* from user_duty a
		where 1=1
		and
		a.duty_id=#{duty_id,jdbcType=INTEGER}
	</select>
</mapper>
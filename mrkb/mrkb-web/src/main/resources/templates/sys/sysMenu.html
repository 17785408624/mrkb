<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head><div th:replace="common/common :: common_resource"></div>
    <meta charset="utf-8">
    <title>菜单管理</title>
    <style>
    	.icon_pic_card_box{
    		float: left;
    		cursor:pointer;
    		border: solid 1px transparent;
    	}
    	.icon_pic_card_box:hover{
    		color: red;
    		border: solid 1px;
    	}
    </style>
</head>
	<body>
		<!--列表-->
		<div id="rapp">
		    <div v-show="showList">
		    	<!-- shiro按钮权限示例:<p shiro:hasPermission="sys:menu">有权限</p> -->
		    	<fieldset class="layui-elem-field site-demo-button" style="margin-top: 10px;">
				    <button class="layui-btn layui-btn-primary" @click="add"><i class="layui-icon layui-icon-add-1"></i>新增</button>
					<div class="layui-input-inline" style="width:200px;">
			           <input type="text" id="serch_menue_name" placeholder="菜单名称" autocomplete="off" class="layui-input">
			        </div>
			        <div class="layui-input-inline" style="width:200px;">
			           <button class="layui-btn layui-btn-primary" @click="serch"><i class="layui-icon layui-icon-search"></i>搜索</button>
			        </div>
				</fieldset>
			    <table class="layui-table" lay-filter="test">
			        <thead>
			            <tr>
			                <th>ID</th>
			                <th>菜单名称</th>
			                <th>菜单图标</th>
			                <th>菜单地址</th>
			                <th>菜单介绍</th>
			                <th>排序序列</th>
			                <th>操作</th>
			            </tr>
			        </thead>
			        <tbody>
			            <tr v-for="item in data">
			                <td>{{item.id}}</td>
			                <td>{{item.name}}</td>
			                <td>{{item.icon}}</td>
			                <td>{{item.url}}</td>
			                <td>{{item.intro}}</td>
			                <td>{{item.sn}}</td>
			                <td>
  								<a class="layui-btn layui-btn-xs" lay-event="edit" @click='edit(item.id)'><i class="layui-icon layui-icon-edit"></i>编辑</a>
  								<a class="layui-btn layui-btn-xs" lay-event="editPermission" @click='editPermission(item.id)'><i class="layui-icon layui-icon-auz"></i>菜单权限编辑</a>
  								<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" @click='del(item.id)'><i class="layui-icon layui-icon-delete"></i>删除</a>
			                </td>
			            </tr>
			        </tbody>
			    </table>
		    	<!--分页容器-->
				<div id="pagination"></div>
		    </div>
		    <!-- 新增面板 -->
		    <div v-show="!showList" class="layui-card">
		    	<div class="layui-card-header">{{title}}</div>
		    	<div class="layui-card-body">
		    		<form class="layui-form" id="layui-form">
					    <div class="layui-form-item">
						    <label class="layui-form-label">排序编号</label>
					    	<div class="layui-input-block">
					        	<input type="text" name="sn" required  lay-verify="required" v-model="sysMenu.sn" placeholder="请输入排序编号" autocomplete="off" class="layui-input">
					    	</div>
					    </div>
					    <div class="layui-form-item">
						    <label class="layui-form-label">菜单名称</label>
					    	<div class="layui-input-block">
					        	<input type="text" name="name" id="menue_name" required  lay-verify="required" v-model="sysMenu.name" placeholder="请输入菜单名称" autocomplete="off" class="layui-input">
					    	</div>
					    </div>
					    <div class="layui-form-item">
						    <label class="layui-form-label">菜单图标</label>
					    	<div class="layui-input-block">
					        	<input type="text" id="icon" name="icon" required  lay-verify="required" @click="picIcon" v-model="sysMenu.icon" placeholder="选择菜单图标" autocomplete="off" class="layui-input">
					    	</div>
					    </div>
					    <div class="layui-form-item">
				    	    <label class="layui-form-label">上级菜单</label>
					        <div class="layui-input-block">
						       <select name="parent_id" id="parent_id" v-model="sysMenu.parent_id" required lay-verify="required" lay-filter="parent_id">
						         <option value=""></option>
						       </select>
					        </div>
					     </div>
				         <div class="layui-form-item">
						    <label class="layui-form-label">菜单地址</label>
					    	<div class="layui-input-block">
					        	<input type="text" name="url" required lay-verify="required" v-model="sysMenu.url" placeholder="请输入地址" autocomplete="off" class="layui-input">
					    	</div>
					      </div>
					      <div class="layui-form-item">
						    <label class="layui-form-label">菜单说明</label>
					    	<div class="layui-input-block">
					        	<input type="text" name="intro" v-model="sysMenu.intro" placeholder="请输入菜单介绍" autocomplete="off" class="layui-input">
					    	</div>
					      </div>
						  <div class="layui-form-item">
						     <div class="layui-input-block">
						       <button type="button" class="layui-btn layui-btn-primary" @click="save"><i class="layui-icon layui-icon-ok"></i>提交</button>
						       <button type="reset" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-refresh-3"></i>重置</button>
						       <button class="layui-btn layui-btn-primary" @click="reload"><i class="layui-icon layui-icon-return"></i>返回</button> 
						     </div>
						  </div>
					</form>
			    </div>
		    </div>
		</div>
		<script type="text/javascript">
		var vm = new Vue({
		    el: "#rapp",
		    data: {
		        data: null,
		        showList: true,
		        title: null,
		        sysMenu: {icon:'icon_01'},
		    },
		    methods: {
		    	add: function () {
		            vm.sysMenu = {};
		            vm.showList = false;
		            vm.title = "新增";
		            //初始化输入框或者选择框
		            vm.sysMenu = {
		            	//例如
		            	url:'/'
		            };
		            //下拉框查询
		            vm.getselectoptions();
		        },
		        //录入、修改保存
		        save:function(){
		        	var url = vm.sysMenu.id == null ? "/sysMenu/insertMenue" : "/sysMenu/editMenu";
		        	var parent_id=$("#parent_id").val();
		        	vm.sysMenu.parent_id=parent_id;
		        	if(vm.sysMenu.name == null || vm.sysMenu.name.length<=0){
		        		layer.tips('菜单名不能为空', '#menue_name', {
						  tips: [3, '#0FA6D8'] //还可配置颜色
						});
						return;
		        	}
		        	$.ajax({
		                type: "POST",
		                url: basePath+url,
		                contentType:'application/json',
		                async:true,
		                data: JSON.stringify(vm.sysMenu),
		                success: function (r) {
		                    if (r.errorCode == 200) {
		                       vm.reload();
		                       layer.msg(r.message);
		                    } else {
		                        layer.msg(r.message);
		                    }
		                },error:function(r){
		                	layer.msg(r.message);
		                }
		            });
		        },
		        //选图标
		        picIcon:function(){
		        	var html="<div class='layui-card' id='icon_pic_card'>";
						  html+="<div class='layui-card-header' style='background-color: #333333;color:#fff'>选择图标</div>";
						  html+="<div class='layui-card-body'>";
						    for(var i=1;i<=117;i++){
						    	html+="<div class='icon_pic_card_box' onclick=\"vm.geticonPath('icon_"+i+"')\">";
						    	html+="<img src=\"../img/menuicon/icon_"+i+".png\" width=\"30\" height=\"30\" style='padding:3px'>";
						    	html+="</div>";
						    }
						  html+="<div style='clear:both'>";
						  html+="</div>";
						  html+="</div>";
						html+="</div>";
		        	layer.open({
					  type: 1,
					  title: false,
					  closeBtn: 1,
					  area: '516px',
					  skin: 'layui-layer-nobg', //没有背景色
					  shadeClose: true,
					  content: html
					});
		        },
		        //获取图标地址，赋值给输入框
		        geticonPath: function(path){
		        	Vue.set(vm.sysMenu, 'icon',path);
		       		layer.closeAll();
		        },
		        //查询菜单下拉框列表
		        getselectoptions(){
		        	$('#parent_id').html("");
		        	$('#parent_id').append(new Option("请选择",""));
		        	$.get(basePath+"/sysMenu/get_menuselect",function (r) {
			        	for(var i=0;i<r.data.length;i++){
			        		$('#parent_id').append(new Option(r.data[i].name,r.data[i].id));
			        	}
			        	layui.form.render("select");
            		});
		        },
		        //修改查询数据
		        edit: function(id){
		        	vm.sysMenu = {};
		            vm.showList = false;
		            vm.title = "编辑";
		            //下拉框查询
		            vm.getselectoptions();
		        	$.ajax({
		                type: "GET",
		                url: basePath+"/sysMenu/getById/"+id,
		                async:true,
		                success: function (r) {
		                	vm.sysMenu = r.data;
		                	if(vm.sysMenu.parent_id==0){
		                		$('#parent_id').attr("disabled","disabled");
		                	}else{
		                		$('#parent_id').removeAttr("disabled");
		                	}
		                	var select = 'dd[lay-value=' + r.data.parent_id + ']';
		                	$('#parent_id').siblings("div.layui-form-select").find('dl').find(select).click();
		                    layer.msg(r.message);
		                },error:function(r){
		                	layer.msg(r.message);
		                }
		            });
		        },
		        //编辑菜单权限
		        editPermission: function(id){
		        	layer.open({
					  type: 2,
					  title:'菜单权限编辑',
					  area: ['400px', '300px'],
					  fixed: false, //不固定
					  maxmin: false,
					  content: basePath+'/userPermission/permissionEditPage/'+id
					});
		        },
		        //删除菜单
		        del: function(id){
		        	$.get(basePath+"/sysMenu/isPermission/"+id,function(data){
		        		if(data.data){
		        			layer.confirm('菜单已经开通权限，删除菜单将删除该菜单权限！', {
							   btn: ['确定','取消'] //按钮
							}, function(){
							   $.get(basePath+"/sysMenu/removeMenu/"+id,function(data){
							   		layer.msg(data.message);
							   		vm.reload();
							   });
							}, function(){
							   layer.msg('取消操作', {icon: 2});
							});
		        		}else{
		        			layer.confirm('是否删除该菜单？操作不可恢复！', {
							   btn: ['确定','取消'] //按钮
							}, function(){
							   $.get(basePath+"/sysMenu/removeMenu/"+id,function(data){
							   	   layer.msg(data.message);
							   	   vm.reload();
							   });
							}, function(){
							   layer.msg('取消操作', {icon: 2});
							});
		        		}
    				});
		        },
		        //搜索
		        serch: function (){
		        	var name = $("#serch_menue_name").val();
		        	pagination(1,10,name);
		        },
		        //刷新面板
		        reload: function (event) {
		            vm.showList = true;
		            vm.serch(); 
		        }
		    }
		});
		//使用layui分页
		//使用layui分页
	    var pageIndex = 1;
		var pageSize = 10;
		var totalCount = 0;
		pagination(pageIndex,pageSize);
		layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element','form','slider'], function(){
		    var laydate = layui.laypage,
		    layer = layui.layer, //弹层
		    table = layui.table, //表格
		    carousel = layui.carousel, //轮播
		    upload = layui.upload, //上传
		    element = layui.element, //元素操作
		    slider = layui.slider, //滑块
		    form = layui.form,
		    laypage = layui.laypage
		    laypage.render({
		        elem: 'pagination'
		        , count: totalCount
		        , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
		        , jump: function (obj, first) {
		            //点击非第一页页码时的处理逻辑。比如这里调用了ajax方法，异步获取分页数据
		            if (!first) {
		                pagination(obj.curr, obj.limit);//第二个参数不能用变量pageSize，因为当切换每页大小的时候会出问题
		            }
		        },
		        
		    });
		    //layui onchange事件
// 		    form.on('select(parent_id)', function(data){   
// 			   var val=data.value;
// 			   console.info(val);
	
//             });
		});
		function pagination(pageIndex,pageSize,name){
			//查询条件
		    var param = {
		        pageIndex: pageIndex,
		        pageSize: pageSize,
		        name: name
		        //其它查询条件可在下面添加
		    };
		    $.ajax({
		        type: 'POST',
		        url: basePath+'/sysMenu/menueList',
		        dataType: 'json',
                data: param,
		        async: false,//这里设置为同步执行，目的是等数据加载完再调用layui分页组件，不然分页组件拿不到totalCount的值
		        success: function (data) {
		            vm.data = data.data.list;
		            totalCount = data.data.total;
		        }
		    });
		};
		</script>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head><div th:replace="common/common :: common_resource"></div>
    <meta charset="utf-8">
    <title>用户管理</title>
  
<body>
  <body>
	<!--列表-->
	<div id="rapp">
	    <div v-show="showList">
	    	<!-- shiro按钮权限示例:<p shiro:hasPermission="sys:menu">有权限</p> -->
	    	<fieldset class="layui-elem-field site-demo-button" style="margin-top: 10px;">
			    <!--<button class="layui-btn layui-btn-primary" @click="add"><i class="layui-icon layui-icon-add-1"></i>新增</button>-->
				<div class="layui-input-inline" style="width:200px;">
		           <input type="text" id="serch_nickname" placeholder="用户昵称" autocomplete="off" class="layui-input">
		        </div>
		        <div class="layui-input-inline" style="width:200px;">
		           <button class="layui-btn layui-btn-primary" @click="serch"><i class="layui-icon layui-icon-search"></i>搜索</button>
		        </div>
			</fieldset>
		    <table class="layui-table" lay-filter="test">
		        <thead>
		            <tr>
		                <th>用户Id</th>
		                <th>用户昵称</th>
		                <th>用户注册时间</th>
		                <th>用户注册地址</th>
		                <th>用户账号</th>
		                <th>操作</th>
		            </tr>
		        </thead>
		        <tbody>
		            <tr v-for="item in data">
		                <td>{{item.user_basics_id}}</td>
		                <td>{{item.user_nickname}}</td>
		                <td>{{formatDateTimeStr(item.user_register_data,1)}}</td>
		                <td>{{item.user_register_address}}</td>
		                <td>{{item.user_account_num}}</td>
		                <td>
							<a class="layui-btn layui-btn-xs" lay-event="edit" @click='edit(item.user_basics_id)'><i class="layui-icon layui-icon-edit"></i>编辑</a>
							<a shiro:hasPermission="sys:remove" class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" @click='del(item.user_basics_id)'><i class="layui-icon layui-icon-delete"></i>删除</a>
		                </td>
		            </tr>
		        </tbody>
		    </table>
	    	<!--分页容器-->
			<div id="pagination"></div>
	    </div>
	    <!-- 新增面板 -->
	    <div v-show="!showList" class="layui-card">
	    	<div class="layui-card-header">{{title}}</div>
	    	<div class="layui-card-body">
	    		<form class="layui-form" id="layui-form">
				    <div class="layui-form-item">
					    <label class="layui-form-label">用户昵称</label>
				    	<div class="layui-input-block">
				        	<input type="text" id="user_nickname" name="user_nickname" lay-verify="required" v-model="user.user_nickname" placeholder="请输入用户昵称" autocomplete="off" class="layui-input">
				    	</div>
				    </div>
				    <div class="layui-form-item">
					    <label class="layui-form-label">用户账号</label>
				    	<div class="layui-input-block">
				        	<input type="text" name="user_account_num" id="user_account_num" lay-verify="required" v-model="user.user_account_num" placeholder="请输入用户账号" autocomplete="off" class="layui-input">
				    	</div>
				    </div>
				     <div class="layui-form-item">
				    	    <label class="layui-form-label">用户角色</label>
					        <div class="layui-input-block">
						       <select name="role_id" id="role_id" lay-filter="role_id">
						         <option value=""></option>
						       </select>
					        </div>
					     </div>
				    <div class="layui-form-item">
				       <div class="layui-input-block">
				         <button type="button" class="layui-btn layui-btn-primary" @click="save"><i class="layui-icon layui-icon-ok"></i>提交</button>
				         <button type="reset" class="layui-btn layui-btn-primary"><i class="layui-icon layui-icon-refresh-3"></i>重置</button>
				         <button class="layui-btn layui-btn-primary" @click="reload"><i class="layui-icon layui-icon-return"></i>返回</button> 
				       </div>
				    </div>
				</form>
		    </div>
	    </div>
	</div>
<script type="text/javascript">
		//使用layui分页参数
	    var pageIndex = 1;
		var pageSize = 10;
		var totalCount = 0;
		//初始化vue对象
		var vm = new Vue({
		    el: "#rapp",
		    data: {
		        data: null,
		        showList: true,
		        title: null,
		        user: {}
		    },
		     methods: {
		        del :function(user_id){
					layer.confirm('是否确认删除！删除后不可恢复?',{btn: ['确定','取消']},function(){
					   $.post(basePath+"/sysUserMg/removeUser/"+user_id,function(data) {
			        		layer.msg(data.message);
			        	});
					}, function(){
					   layer.msg('取消操作', {icon: 2});
					});
	        	},
		        add :function(){
		        	vm.user = {};
		            vm.showList = false;
		            vm.title = "新增";
		            this.getRoleSelectOption();
		        },
		        edit :function(user_id){
		        	vm.user = {};
		            vm.showList = false;
		            vm.title = "编辑";
		            //下拉框查询
		            this.getRoleSelectOption();
		        	$.ajax({
		                type: "GET",
		                url: basePath+"/userRole/getRoleByUserId/"+user_id,
		                async:true,
		                success: function (r) {
		                	var select = 'dd[lay-value=' + r.data.role_id + ']';
		                	$('#role_id').siblings("div.layui-form-select").find('dl').find(select).click();
		                    layer.msg(r.message);
		                },error:function(r){
		                	layer.msg(r.message);
		                }
		            });
		            $.get(basePath+'/sysUserMg/findUserByUserId/'+user_id,function(data) {
		            	vm.user=data.data;
		            })
		        },
		        save :function(){
		        	var url = vm.user.user_basics_id == null ? "/sysUserMg/addNewUser" : "/sysUserMg/editUser";
		        	var role_id=$("#role_id").val();
		        	vm.user.role_id=role_id;
		        	if(vm.user.user_nickname == null || vm.user.user_nickname.length<=0){
		        		layer.tips('昵称不能为空', '#user_nickname', {
						  tips: [3, '#0FA6D8'] //还可配置颜色
						});
						return;
		        	}
		        	if(vm.user.user_account_num == null || vm.user.user_account_num.length<=0){
		        		layer.tips('账号不能为空', '#user_account_num', {
						  tips: [3, '#0FA6D8'] //还可配置颜色
						});
						return;
		        	}
		        	if(vm.user.role_id == null || vm.user.role_id<=0){
		        		layer.tips('角色不能为空', '#role_id', {
						  tips: [3, '#0FA6D8'] //还可配置颜色
						});
						return;
		        	}
		        	$.ajax({
		                type: "POST",
		                url: basePath+url,
		                contentType:'application/json',
		                async:true,
		                data:JSON.stringify(vm.user),
		                success: function (r) {
		                    if (r.errorCode == 200) {
		                       vm.reload();
		                       layer.msg(r.message);
		                    } else {
		                        layer.msg(r.message);
		                    }
		                },error:function(r){
		                	layer.msg(r.message);
		                }
		            });
		        },
		        //搜索
		        serch: function (){
		        	var nickname = $("#serch_nickname").val();
		        	pagination(1,10,nickname);
		        },
		        //刷新面板
		        reload: function (event) {
		            vm.showList = true;
		            vm.serch(); 
		        },
		        getRoleSelectOption:function(){
		        	$('#role_id').html("");
		        	$('#role_id').append(new Option("请选择",""));
		        	$.get(basePath+"/userRole/getRoleList",function (r) {
			        	for(var i=0;i<r.data.length;i++){
			        		$('#role_id').append(new Option(r.data[i].name,r.data[i].id));
			        	}
			        	layui.form.render("select");
            		});
		        }
	        }
	    });
		pagination(pageIndex,pageSize);
		layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element','form','slider'], function(){
		    var laydate = layui.laypage,
		    layer = layui.layer, //弹层
		    table = layui.table, //表格
		    carousel = layui.carousel, //轮播
		    upload = layui.upload, //上传
		    element = layui.element, //元素操作
		    slider = layui.slider, //滑块
		    form = layui.form,
		    laypage = layui.laypage
		    laypage.render({
		        elem: 'pagination'
		        , count: totalCount
		        , layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
		        , jump: function (obj, first) {
		            //点击非第一页页码时的处理逻辑。比如这里调用了ajax方法，异步获取分页数据
		            if (!first) {
		                pagination(obj.curr, obj.limit);//第二个参数不能用变量pageSize，因为当切换每页大小的时候会出问题
		                pageIndex = obj.curr;
						pageSize = obj.limit;
		            }
		        },
		        
		    });
		    //layui下拉框选择事件
		    form.on('select(order_status)', function(data){
// 				console.log(data.elem); //得到select原始DOM对象
// 				console.log(data.value); //得到被选中的值
// 				console.log(data.othis); //得到美化后的DOM对象
				pagination(pageIndex,pageSize,data.value)
			});

		});
		function pagination(pageIndex,pageSize,nickname){
			//查询条件
		    var param = {
		        pageIndex: pageIndex,
		        pageSize: pageSize,
		        nickname: nickname
		        //其它查询条件可在下面添加
		    };
		    $.ajax({
		        type: 'POST',
		        url: basePath+'/sysUserMg/getUserPageList',
		        dataType: 'json',
                data: param,
		        async: false,//这里设置为同步执行，目的是等数据加载完再调用layui分页组件，不然分页组件拿不到totalCount的值
		        success: function (data) {
		            vm.data = data.data.list;
		            totalCount = data.data.total;
		        }
		    });
		};
</script>
</body>
</html>

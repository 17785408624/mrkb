<html xmlns:th="http://www.thymeleaf.org">
<head>
<div th:replace="common/common :: common_resource"></div>
<meta charset="utf-8">
<title>知识视频轮播图</title>
<style type="text/css">
.uploader-list {
	margin-left: -15px;
}

.uploader-list .info {
	position: relative;
	margin-top: -25px;
	background-color: black;
	color: white;
	filter: alpha(Opacity = 80);
	-moz-opacity: 0.5;
	opacity: 0.5;
	width: 100px;
	height: 25px;
	text-align: center;
	display: none;
}

.uploader-list .handle {
	position: relative;
	background-color: black;
	color: white;
	filter: alpha(Opacity = 80);
	-moz-opacity: 0.5;
	opacity: 0.5;
	width: 100px;
	text-align: right;
	height: 18px;
	margin-bottom: -18px;
	display: none;
}

.uploader-list .handle span {
	margin-right: 5px;
}

.uploader-list .handle span:hover {
	cursor: pointer;
}

.uploader-list .file-iteme {
	margin: 12px 0 0 15px;
	padding: 1px;
	float: left;
}
</style>
</head>
<body>
	<!--列表-->
	<div id="vueContainer">
		<div v-show="showList">
			<fieldset class="layui-elem-field site-demo-button"
				style="margin-top: 30px;">
				  <form class="layui-form">
	           		<label class="layui-form-label">类型</label>
			    <div class="layui-input-block" style="width:190px;">
			      <select name="news_type_serch" lay-filter="news_type_serch" id="news_type_serch">
			        <option value="0">全部</option>
			        <option value="4">视频</option>
			        <option value="6">首页轮播图</option>
			        <option value="7">积分商城轮播图</option>
			        <option value="8">成长课程播图</option>
			        <option value="9">公众号操作手册</option>
			        <option value="10">公司介绍</option>
			        <option value="11">成长</option>
			        <option value="12">关系</option>
			        <option value="13">财富</option>
			        <option value="14">企业</option>
			      </select>
			    </div>
	           </form>
				<div>
					<button class="layui-btn" @click="add">
						<i class="layui-icon layui-icon-add-1"></i>新增
					</button>
				</div>
				<!-- <div class="layui-input-inline" style="width:200px;">
					<input type="text" id="search_news_title" placeholder="请输入标题搜索"
						autocomplete="off" class="layui-input">
				</div>
				<div class="layui-input-inline" style="width:200px;">
					<button class="layui-btn layui-btn-primary" @click="serch">
						<i class="layui-icon layui-icon-search"></i>搜索
					</button>
				</div> -->
			</fieldset>
			<table class="layui-table" lay-filter="test">
				<thead>
					<tr>
						<th>编号</th>
						<th>标题</th>
						<th>类型</th>
						<th>阅读量</th>
						<th>点赞量</th>
						<th>添加时间</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="item in data">
						<td>{{item.news_id}}</td>
						<td>{{item.news_title}}</td>
						<td v-if="item.news_type==4">视频</td>
						<td v-if="item.news_type==6">首页轮播图</td>
						<td v-if="item.news_type==7">大丰收轮播图</td>
						<td v-if="item.news_type==8">大成长轮播图</td>
						<td v-if="item.news_type==9">公众号操作手册</td>
						<td v-if="item.news_type==10">公司介绍</td>
						<td v-if="item.news_type==11">成长</td>
						<td v-if="item.news_type==12">关系</td>
						<td v-if="item.news_type==13">财富</td>
						<td v-if="item.news_type==14">企业</td>
						<td>{{item.read_num}}</td>
						<td>{{item.thumbs_up}}</td>
						<td>{{formatDateTimeStr(item.add_date,1)}}</td>
						<td><a class="layui-btn layui-btn-xs" lay-event="edit"
							@click='edit(item.news_id)'>查看</a> <a
							class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"
							@click='del(item.news_id)'>删除</a></td>
					</tr>
				</tbody>
			</table>
			<!--分页容器-->
			<div id="pagination"></div>
		</div>
		<!-- 新增面板 -->
		<div v-show="!showList" class="layui-card">
			<div class="layui-card-header">{{title}}</div>
			<div class="layui-card-body">
				<form class="layui-form">
					
					<div class="layui-form-item">
						<label class="layui-form-label">标    题</label>
						<div class="layui-input-block">
							<input type="text" name="news_title" id="news_title"
								v-model="news.news_title" placeholder="请输入标题"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" >
						<label class="layui-form-label">发布类型</label>
						<div class="layui-input-block" id="selectNews">
							<select name="news_type" id="news_type"
								 lay-filter="news_type">
						        <option value="4">视频</option>
						        <option value="6">首页轮播图</option>
						        <option value="7">大丰收轮播图</option>
						        <option value="8">大成长轮播图</option>
						        <option value="9">公众号操作手册</option>
						        <option value="10">公司介绍</option>
						        <option value="11">成长</option>
						        <option value="12">关系</option>
						        <option value="13">财富</option>
						        <option value="14">企业</option>
							</select>
						</div>
					</div>
					<div class="layui-form-item" id="views1" >
						<label class="layui-form-label">视    频</label>
						<div class="layui-input-block">
							<button type="button" class="layui-btn" id="viewsid"><i class="layui-icon"></i>上传视频</button>
						</div>
					</div>
					<div class="layui-form-item" id="views2" >
						<label class="layui-form-label">视频路径</label>
						<div class="layui-input-block">
							<input type="text" name="news_road" id="news_road"
								v-model="news.news_road" placeholder="" readonly="readonly"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-input-block">
							<input type="hidden" name="news_picture"
								v-model="news.news_picture" placeholder="请上传图片"
								autocomplete="off" class="layui-input">
						</div>
						<div class="layui-upload">
							<button type="button" class="layui-btn" id="upload">图片上传</button>
							<blockquote class="layui-elem-quote layui-quote-nm"
								style="margin-top: 10px;width: 88%">
								预览图：
								<div class="layui-upload-list uploader-list"
									style="overflow: auto;" id="uploader-list"></div>
							</blockquote>
						</div>
					</div>
					<textarea class="layui-textarea" id="editor" style="display: none"
						lay-verify="content">  
  						
					</textarea>
					<!-- <li class="clearfix"><label class="label_name col-xs-1"><i></i>内容介绍：&nbsp;&nbsp;</label>
    					<div class="Add_content col-xs-11"><script id="editor" type="text/plain" style="width:100%;height:500px;"></script></div>
     				</li>  -->

					<div class="layui-form-item">
						<div class="layui-input-block">
							<button type="button" class="layui-btn layui-btn-primary"
								@click="save">
								<i class="layui-icon layui-icon-ok"></i>提交
							</button>
							<button type="reset" class="layui-btn layui-btn-primary">
								<i class="layui-icon layui-icon-refresh-3"></i>重置
							</button>
							<button class="layui-btn layui-btn-primary" @click="reload">
								<i class="layui-icon layui-icon-return"></i>返回
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		var active = {};
		layui.use([ 'laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element', 'slider', 'form', 'layedit' ], function() {
			var laydate = layui.laypage,
				layer = layui.layer, //弹层
				table = layui.table, //表格
				carousel = layui.carousel, //轮播
				upload = layui.upload, //上传
				element = layui.element, //元素操作
				slider = layui.slider, //滑块
				form = layui.form,
				laypage = layui.laypage,
				layedit = layui.layedit
				laypage.render({
					elem : 'pagination',
					count : totalCount,
					layout : [ 'count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip' ],
					jump : function(obj, first) {
						//点击非第一页页码时的处理逻辑。比如这里调用了ajax方法，异步获取分页数据
						if (!first) {
							pagination(obj.curr, obj.limit); //第二个参数不能用变量pageSize，因为当切换每页大小的时候会出问题
						}
					},
			});
			form.on('select(news_type)', function($event) { //
				var val = $event.value;
				if (val == 4||val ==5||val == 1||val == 11||val == 12||val == 13||val == 14) { //
					
					$("#views1").show();
					$("#views2").show();
				} else {
					$("#views1").hide();
					$("#views2").hide();
				}
			});
			//富文本图片上传
			layedit.set({
				uploadImage : {
					url : basePath + '/layuiupload/uploadNewsImg', //接口url
					type : 'post' //默认post
				}
			});
			var index = layedit.build('editor');
			//编辑器外部操作
			active = {
				content : function() {
					return layedit.getContent(index);
					alert(layedit.getContent(index)); //获取编辑器内容
				},
				text : function() {
					alert(layedit.getText(index)); //获取编辑器纯文本内容
				},
				selection : function() {
					alert(layedit.getSelection(index));
				},
				setNews : function() {
					//alert(12);
					layedit.setContent(index, vue.news.detail_content);
				}
			};
			$('.site-demo-layedit').on('click', function() {
				var type = $(this).data('type');
				active[type] ? active[type].call(this) : '';
			});
			//视频上传
			upload.render({
			    elem: '#viewsid'
			    ,url: basePath + '/layuiupload/uploadViews'
			    ,accept: 'video' //视频
			    ,done: function(res){
			    	alert("上传完成");
			    	$("#news_road").val(res.data);
			      	console.log(res)
			    }
			});
	
		});
		var vue = new Vue({
			el : "#vueContainer",
			data : {
				data : null,
				showList : true,
				title : null,
				news : {},
			},
			methods : {
				add : function() {
					vue.news = {};
					vue.showList = false;
					vue.title = "新增";
					//初始化输入框或者选择框
					vue.news = {
						//例如
						/* course_type : 0, //将value值初始化
						academic_type : 0, //将value值初始化
						user_grade_id : 0, //将value值初始化
						store_type : 0 //将value值初始化 */
					};
				},
				save : function() {
					var detail_content = active.content();
					var news_type = $("#news_type").val(); //根据id获取课程类型下拉框的value值
					var news_title = $("#news_title").val(); //根据id获取学院类型下拉框value的值
					var news_road = $("#news_road").val(); //根据id获取所属乐唐(1.是，2.否)类型下拉框value的值
					vue.news.news_type = news_type; //设置商品类型初始值
					vue.news.news_title = news_title; //设置学院类型初始值
					vue.news.detail_content = detail_content; //编辑器内容
					vue.news.view_road = news_road;//视频路径
					if (vue.news.news_title == null || vue.news.news_title.length <= 0) {
						layer.tips('标题不能为空', '#news_title', {
							tips : [ 3, '#0FA6D8' ] //还可配置颜色
						});
						return;
					}
					
					/**定义是新增还是修改*/
					var url = vue.news.news_id == null ? "/admin_news/addNews" : "/admin_news/updateNews";
					$.ajax({
						type : "POST",
						url : basePath + url,
						contentType : 'application/json',
						async : true,
						data : JSON.stringify(vue.news),
						success : function(r) {
							if (r.errorCode == 200) {
								layer.msg("修改成功");
								vue.reload();
							} else {
								layer.msg(r.message);
							}
						}
					});
				},
				//修改查询数据
				edit : function(id) {
					//alert(11);
					vue.news = {};
					vue.showList = false;
					vue.title = "编辑";
					//下拉框查询
					//this.getselectoptions();
					$.ajax({
						type : "GET",
						url : basePath + "/admin_news/findNewsOne/" + id,
						async : true,
						success : function(r) {
							vue.news = r.data;
							/*回显图片pictures*/
							var pictures = vue.news.news_picture.split(";");
							for (var i = 0; i < pictures.length - 1; i++) {
								$('#uploader-list').append(
									'<div id="" class="file-iteme">' +
									'<div class="handle"><span class="glyphicon glyphicon-trash"></span></div>' +
									'<img style="width: 100px;height: 100px;" src=' +pictures[i] + '>' +
									'<div class="info">' + 'lll' + '</div>' +
									'</div>');
							}
							active.setNews(); //给富文本编辑器赋值
	
							/*类型下拉框禁用*/
							$("#news_type").attr("disabled", "disabled");
							var select0 = 'dd[lay-value=' + r.data.news_type + ']';
							$('#news_type').siblings("div.layui-form-select").find('dl').find(select0).click();
							layui.form.render('select');
						},
						error : function(r) {
							layer.msg(r.data.message);
						}
					});
				},
				//删除
                del : function(id) {
                    layer.confirm('确定删除？', {
                        btn : [ '确定', '取消' ] //按钮
                    }, function() {
                        $.get(basePath + "/admin_news/deleteNew/" + id, function(data) {
                            layer.msg(data.message);
                            vue.reload();
                        });
                    }, function() {
                        layer.msg('取消操作', {
                            icon : 2
                        });
                    });
                },
				//搜索
				serch : function() {
					var news_title = $("#search_news_title").val();
	
					pagination(1, 10, news_title);
				},
	
				reload : function(event) {
					vue.showList = true;
				}
			}
		});
		//使用layui分页
		var pageIndex = 1;
		var pageSize = 10;
		var totalCount = 0;
		pagination(pageIndex, pageSize);
		function pagination(pageIndex, pageSize, name) {
			//查询条件
			var param = {
				pageIndex : pageIndex,
				pageSize : pageSize,
				news_type : name
			//其它查询条件可在下面添加
			};
			$.ajax({
				type : 'GET',
				url : basePath + '/admin_news/findNews/' + pageIndex + "/" + pageSize,
				dataType : 'json',
				data : param,
				async : false, //这里设置为同步执行，目的是等数据加载完再调用layui分页组件，不然分页组件拿不到totalCount的值
				success : function(data) {
				   // alert(JSON.stringify(data));
					vue.data = data.data.list;
					totalCount = data.data.total;
				}
			});
		}
		;
	
		var path = ""; //图片路径保存
		/*图片上传*/
		layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element','form','slider'], function(){
		    var laydate = layui.laypage,
		    layer = layui.layer, //弹层
		    table = layui.table, //表格
		    carousel = layui.carousel, //轮播
		    upload = layui.upload, //上传
		    element = layui.element, //元素操作
		    slider = layui.slider, //滑块
		    form = layui.form,
		    laypage = layui.laypage
			//执行实例
			var uploadInst = upload.render({
				elem : '#upload', //绑定元素
				multiple : true,
				exts : 'jpg|png|jpeg',
				size : 2048, //限制文件大小，单位 KB
				url : basePath + '/layuiupload/uploadNewsImg', //上传接口
				before : function(obj) {
					/*layer.close(layer.msg());//关闭上传提示窗口
					 */ //预读本地文件示例，不支持ie8
					obj.preview(function(index, file, result) {
						$('#uploader-list').append(
							'<div id="" class="file-iteme">' +
							'<div class="handle"><span class="glyphicon glyphicon-trash"></span></div>' +
							'<img style="width: 100px;height: 100px;" src=' + result + '>' +
							'<div class="info">' + file.name + '</div>' +
							'</div>'
						);
	
					//$('#uploader-list').append('<img  src="' + result + '" alt="' + file.name + 'style="width: 10px;height: 10px;"' + '" class="layui-upload-img">')
					});
	
					//layer.close(layer.msg()); //关闭上传提示窗口
					layer.msg('图片上传中...', {
						icon : 16,
						shade : 0.01,
						time : 30
					})
				},
	 			
				done : function(res) {
					layer.close(layer.msg()); //关闭上传提示窗口
					//上传完毕回调
					path += res.data.src + ";";
					
					vue.news.news_picture = path;
				//alert("上传成功！");
				},
				error : function() {
					layer.msg('上传错误！');
				//请求异常回调
				}
			});
			//layui下拉框选择事件
		    form.on('select(news_type_serch)', function(data){
		    	//alert(11);
 				console.log(data.elem); //得到select原始DOM对象
 				console.log(data.value); //得到被选中的值
 				console.log(data.othis); //得到美化后的DOM对象
				pagination(pageIndex,pageSize,data.value)
			});
		});
		//鼠标悬浮提示
		$(document).on("mouseenter mouseleave", ".file-iteme", function(event) {
			if (event.type === "mouseenter") {
				//鼠标悬浮
				$(this).children(".info").fadeIn("fast");
				$(this).children(".handle").fadeIn("fast");
			} else if (event.type === "mouseleave") {
				//鼠标离开
				$(this).children(".info").hide();
				$(this).children(".handle").hide();
			}
		});
	
		// 删除图片
		$(document).on("click", ".file-iteme .handle", function(event) {
			$(this).parent().remove();
		});
	</script>


</body>
</html>

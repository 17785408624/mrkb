<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mrkb.shiro.mapper.SysMenuMapper">
	
	 <sql id="Base_Column_List">
		id, sn, name,icon,url, intro, parent_id
     </sql>
	
	<!-- 加载用户的拥有一级菜单 -->
	<select id="listMenue_parent" parameterType="java.lang.Integer" resultType="com.mrkb.shiro.model.SysMenu">
		select * from sys_menu where id in(
		select p.menu_id from sys_permission p
		left JOIN sys_role_permission rp on p.id=rp.permission_id
		left join sys_role ro on rp.role_id=ro.id
		left join sys_user_role rl on ro.id=rl.role_id
		left join user_basics u on rl.user_id=u.user_basics_id where u.user_basics_id=#{userid}
		) and parent_id=0 ORDER BY sn
	</select>
	<!-- 加载用户的拥有二级菜单 -->
	<select id="listMenue_son" parameterType="java.util.HashMap" resultType="com.mrkb.shiro.model.SysMenu">
		select * from sys_menu where id in(
		select p.menu_id from sys_permission p
		left JOIN sys_role_permission rp on p.id=rp.permission_id
		left join sys_role ro on rp.role_id=ro.id
		left join sys_user_role rl on ro.id=rl.role_id
		left join user_basics u on rl.user_id=u.user_basics_id where u.user_basics_id=#{userid}
		) and parent_id=#{parent_id}
	</select>
	
	
	
	<!-- 根据ID查询菜单 -->
	<select id="get" parameterType="java.lang.Integer" resultType="com.mrkb.shiro.model.SysMenu">
		SELECT 
		<include refid="Base_Column_List"/>
		from sys_menu where id=#{id}
	</select>
	
	
	<!-- 分页查询 -->
	<select id="pageList" parameterType="java.util.HashMap" resultType="com.mrkb.shiro.model.SysMenu">
		select 
		<include refid="Base_Column_List"/>
		from sys_menu
		<where>
            <if test="name != null and name != ''">
                and `name` like concat('%',#{name},'%')
            </if>
        </where>
        order by sn asc
	</select>
	
	
	<!-- 查询所有父级菜单，下拉框使用 -->
	<select id="creat_menuselect" resultType="com.mrkb.shiro.model.SysMenu">
		SELECT 
		<include refid="Base_Column_List"/>
		from sys_menu where parent_id=0
	</select>
	
	<!-- 新增菜单 -->
	<insert id="insert" parameterType="com.mrkb.shiro.model.SysMenu">
		insert into sys_menu(
			`sn`, `name`,`icon`,`url`, `intro`, `parent_id`
		)values(
			#{sn}, 
			#{name}, 
			#{icon}, 
			#{url}, 
			#{intro}, 
			#{parent_id}
		)
	</insert>
	
	
	<!-- 删除菜单 -->
	<delete id="delete" parameterType="java.lang.Integer">
		delete from sys_menu where id=#{id}
	</delete>
	
	
	<!-- 修改菜单 -->
	<update id="update" parameterType="com.mrkb.shiro.model.SysMenu">
		update sys_menu
		<set>
			<if test="sn != null">`sn` = #{sn},</if>
			<if test="name != null">`name` = #{name},</if>
			<if test="icon != null">`icon` = #{icon},</if>
			<if test="url != null">`url` = #{url},</if>
			<if test="intro != null">`intro` = #{intro},</if>
			<if test="parent_id != null">`parent_id` = #{parent_id},</if>
		</set>
		where id=#{id}
	</update>
	
	
	<!-- 检查菜单是否已被分配权限 -->
	<select id="checkIsPermission" parameterType="java.lang.Integer" resultType="java.lang.Integer">
		select count(0) from sys_permission where menu_id=#{menu_id}
	</select>
	
	
	<!-- 获取树形菜单父级菜单 -->
	<select id="getMenuParentTree" resultType="java.util.HashMap">
		select name title,id value from sys_menu where parent_id=0
	</select>
	
	<!-- 获取树形菜单子节点 -->
	<select id="getMenuParentTreeNodes" resultType="java.util.HashMap" parameterType="java.util.HashMap">
		select name title, id value,       
    	case      
   		when id in (select a.menu_id from sys_permission a left join sys_role_permission b on a.id=b.permission_id WHERE b.role_id=#{role_id}) then 'true'
		ELSE 'false'        
        end as 'checked'      
		from sys_menu where parent_id=#{parent_id}
	</select>
	
	
	<!-- 检查是否是父级菜单 -->
	<select id="isparentmenu" parameterType="java.lang.Integer" resultType="com.mrkb.shiro.model.SysMenu">
		SELECT 
		<include refid="Base_Column_List"/>
		from sys_menu where parent_id=0 and id=#{id}
	</select>
	
	
	<!-- 获取父级菜单信息 -->
	<select id="getParentByMenuId" parameterType="java.lang.Integer" resultType="com.mrkb.shiro.model.SysMenu">
		select * from sys_menu where parent_id=#{id}
	</select>
</mapper>